<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>DAQView - React.js</title>

    <link rel="icon" type="image/png" href="dist/img/cms_logo.png">

    <link rel="StyleSheet" href="dist/css/daqview.css" type="text/css"/>
    <link rel="StyleSheet" href="dist/css/components/metadata/metadata-table.css" type="text/css"/>
    <link rel="StyleSheet" href="dist/css/components/fed-builder/fb-table.css" type="text/css"/>
    <link rel="StyleSheet" href="dist/css/components/filter-farm/fff-table.css" type="text/css"/>
    <link rel="StyleSheet" href="dist/css/components/metadata/about-table.css" type="text/css"/>
    <link rel="StyleSheet" href="dist/css/components/metadata/loader.css" type="text/css"/>

    <script type="text/javascript" src="dist/lib/jquery/jquery-3.0.0.min.js"></script>
    <script type="text/javascript" src="dist/lib/classnames/index.js"></script>
    <script type="text/javascript" src="dist/lib/react/react.min.js"></script>
    <script type="text/javascript" src="dist/lib/react/react-dom.min.js"></script>

    <script type="text/javascript" src="dist/js/structures/daq-aggregator/daq-snapshot.js"></script>
    <script type="text/javascript" src="dist/js/utilities/snapshot-provider.js"></script>
    <script type="text/javascript" src="dist/js/utilities/daqview-util.js"></script>
    <script type="text/javascript" src="dist/js/utilities/format-util.js"></script>
    <script type="text/javascript" src="dist/js/utilities/snapshot-randomizer.js"></script>
    <script type="text/javascript" src="dist/js/utilities/parser.js"></script>
    <script type="text/javascript" src="dist/js/components/common/sorting.js"></script>
    <script type="text/javascript" src="dist/js/components/metadata/metadata-table.js"></script>
    <script type="text/javascript" src="dist/js/components/metadata/about-table.js"></script>
    <script type="text/javascript" src="dist/js/components/metadata/loader-replacement.js"></script>
    <script type="text/javascript" src="dist/js/components/fed-builder/fb-table.js"></script>
    <script type="text/javascript" src="dist/js/components/filter-farm/fff-table.js"></script>
    <script type="text/javascript" src="dist/js/daqview.js"></script>

    <script type="text/javascript">
        var daqView; //daqView is an object containing an array of the created views (page components)
        $(document).ready(function () {
            try {
                daqView = new DAQView.DAQViewReact();
                daqView.createMetadataTable('daqview-react-metadata-table');
                daqView.createFBTable('daqview-react-fb-table');
                daqView.createFFFTable('daqview-react-fff-table');
                daqView.createAboutTable('daqview-react-about-table');
                //daqView.createReplacementForLoader('loaderWrapper');   //implement a blank div to replace the loader when react has finished

                // HACK: to avoid browser errors when loading local JSON
                $.ajaxSetup({
                    beforeSend: function (xhr) {
                        if (xhr.overrideMimeType) {
                            xhr.overrideMimeType("application/json");
                        }
                    }
                });
                var parser = new DAQAggregator.SnapshotParser();
                var ruWarningsResolver = new DAQAggregator.RUWarnMessageAggregator();
                var ruMaskedCounter = new DAQAggregator.RUMaskedCounter();
                var buNoRateCounter = new DAQAggregator.BUNoRateCounter();

                var counter = 0;
                var timeStampAtDec2 = 1480678707956;

                //use local aggregator data source (for development)
                var debugSnapshotSource = false;

                var snapshotSource = {
                    updateInterval: 2000,
                    getSourceURL: function () {

                        var serverURL = '"http://pcepcmd62.cern.ch:8080/daqview-react-server/dyndefault?';

                        var baseURL = 'http://daq-expert-dev.cms:8080/DAQExpert/snapshot?time='; //data source URL
                        var timestampDelim = '"';

                        //production timestamp
                        //var currentTime = new Date(new Date().getTime()).toISOString();

                        //simulated timestamp that counts from Dec 2 2016 for development in EYETS (3 days of aggregated data)
                        var currentTime = new Date(timeStampAtDec2+(counter*this.updateInterval)).toISOString();
                        counter++;

                        if (debugSnapshotSource) {
                            baseURL = 'http://pcepcmd62.cern.ch:3000/mydaqview/api/snapshot?time=';
                            timestampDelim = '';
                        }
                        var ret = baseURL + timestampDelim + currentTime + timestampDelim;
                        //window.history.replaceState(null,null, "dyndefault?time="+currentTime);
                        //console.log("data source is:"+baseURL + '"' + currentTime + '"');
                        return ret;
                    },
                    getSourceURLForGotoRequests: function () {

                        var serverURL = '"http://pcepcmd62.cern.ch:8080/daqview-react-server/dyndefault?';

                        var baseURL = 'http://daq-expert-dev.cms:8080/DAQExpert/snapshot?time=';
                        var timestampDelim = '"';

                        var currentTime = $('#daqview-go-to-time-input').val();

                        if (debugSnapshotSource) {
                            baseURL = 'http://pcepcmd62.cern.ch:3000/mydaqview/api/snapshot?time=';
                            timestampDelim = '';
                        }
                        var ret = baseURL + timestampDelim + currentTime + timestampDelim;
                        //window.history.replaceState(null,null, "dyndefault?time="+currentTime);
                        //console.log("data source is:"+baseURL + '"' + currentTime + '"');
                        return ret;
                    },
                    parseSnapshot: (function (snapshot) {
                        console.log(snapshot);

                        //parse original snapshots
                        snapshot = parser.parse.bind(parser)(snapshot);

                        //pass it through chain of preprocessors
                        snapshot = ruWarningsResolver.resolveRUWarnings.bind(ruWarningsResolver)(snapshot);
                        snapshot = ruMaskedCounter.countMaskedRUs.bind(ruMaskedCounter)(snapshot);
                        snapshot = buNoRateCounter.countNoRateBUs.bind(buNoRateCounter)(snapshot);

                        //DAQAggregator.randomizeSnapshot(snapshot, 20); //randomizes snapshot values
                        return snapshot;
                    }).bind(window)
                };

                var snapshotProvider = new DAQAggregator.SnapshotProvider(snapshotSource);
                snapshotProvider.addView(daqView);
                snapshotProvider.start();

                var controlPauseResume = $('.daqview-control-pause-resume');
                controlPauseResume.on('click', function () {

                        //the provider will also stop itself if a go-to-time request is received
                        //this button's appearance is set accordingly (displays 'play') by the event handler of the go-to-time button

                        if (snapshotProvider.isRunning()) {
                            snapshotProvider.provideOneMoreSnapshotAndStop(0); //calling with arg 0 will just redraw previous snapshot with the paused_page color scheme, then stop updating
                            $(this).prop('src', 'dist/img/play.png');
                        } else {
                            //if pause was due to a go-to-time request, then restarting also resets mode to realtime
                            if (!snapshotProvider.inRealTimePolling){
                                snapshotProvider.switchToRealTime();
                            }
                            snapshotProvider.start();

                            $(this).prop('src', 'dist/img/pause.png');
                        }
                });

                var controlGoToTime = $('.daqview-go-to-time');
                controlGoToTime.on('click', function (){
                    snapshotProvider.switchToGotoTimeRequests();
                    snapshotProvider.provideOneMoreSnapshotAndStop(1); //calling with arg 1 will draw the requested snapshot with the paused_page color scheme, then stop updating

                    //useful when requesting a go-to-time timestamp in daqview=paused state
                    if (!snapshotProvider.isRunning()){
                        snapshotProvider.start();
                    }

                    //updating play/pause button, because point queries essentially stop real-time monitoring
                    //the provider will stop itself once a gototime request is received (after providing this last snapshot)
                    $('.daqview-control-pause-resume').prop('src', 'dist/img/play.png');
                });
                //hook_for_the_server_to_trigger_static_display_timestamp__PLEASE_DO_NOT_REMOVE
            }
            catch (exception) {
                console ? (console.debug ? console.debug(exception) : console.log(exception)) : alert(exception);
            }
        });
    </script>
</head>
<body>
<div id="daqview-react">
    <div id="daqview-time-navigation">
            <input type="text" placeholder="please respect format" value="2016-12-03T10:38:26.039Z" id="daqview-go-to-time-input">
            <input type="submit" value="Go to time" class="daqview-go-to-time">
        <p>Please use provided format (ISO) and UTC time:<br/>e.g. 2016-12-03T10:38:26.039Z</p>
    </div>
    <div id="daqview-control">
        <input type="image" class="daqview-control-pause-resume" src="dist/img/pause.png" alt="pause/resume"
               title="pause/resume"/>
    </div>
    <br/><br/>
    <div id="daqview-react-metadata-table"></div>
    <br/><br/>
    <div id="daqview-react-fb-table"></div>
    <br/><br/>
    <div id="daqview-react-fff-table"></div>
    <br/><br/>
    <div id="daqview-react-about-table"><div class="loader"></div></div>
</div>
</body>
</html>